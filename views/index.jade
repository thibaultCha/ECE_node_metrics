extends layout

block content

  :stylus
    content-width = 960px
    graph-width = 800px
    background-color = #ccc
    .container
      width content-width
      margin 0 auto
    #form
      width graph-width
      margin 0 auto
      padding 20px 0
      margin-bottom 50px
      background-color background-color
      h1
        text-align center
    #graph
      width graph-width
      height 400px 
      margin 0 auto
      background-color background-color
    line path
      fill none
      stroke #000
      shape-rendering crispEdges
    .area
      fill steelblue

  form#form(action="/metrics" method="GET")
    h1= title
    label(for="id") Metric id
    input#metric_id(name="metric" placeholder="metric id")
    br
    input#metric_ok(type="submit" value="OK")

  #graph

  :coffee
    $('#metric_ok').click (e) ->
      id = $('#metric_id').val()
      e.preventDefault()
      $.getJSON "/metrics/#{id}.json", {}, (data) ->
        metrics = data.metrics

        $('#graph').html('')

        margin = {top: 20, right: 20, bottom: 30, left: 50}
        width  = 800 - margin.left - margin.right
        height = 400 - margin.top - margin.bottom

        x = d3.time.scale().range [0, width]
        y = d3.scale.linear().range [height, 0]
        xAxis = d3.svg.axis().scale(x).orient "bottom"
        yAxis = d3.svg.axis().scale(y).orient "left"

        area = d3.svg.area()
          .x (m) ->
            return x m.timestamp
          .y0(height)
          .y1 (m) ->
            return y m.value

        svg = d3.select("#graph").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        x.domain d3.extent metrics, (m) ->
          return m.timestamp
        y.domain [0, d3.max metrics, (m) ->
          return m.value]

        svg.append("path")
            .datum(metrics)
            .attr("class", "area")
            .attr("d", area)

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0, " + height + ")")
            .call(xAxis)
            .append("text")
              .attr("x", -4)
              .attr("dx", "1em")
              .text("Time")

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("dy", ".71em")
              .style("text-anchor", "end")
              .text("Value")